local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-----------------------------------------------------------
-- TẠO GUI VĨNH VIỄN (không ResetOnSpawn)
-----------------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Nút mở Menu (đẹp hơn)
local menuButton = Instance.new("TextButton")
menuButton.Size = UDim2.new(0, 120, 0, 50)
menuButton.Position = UDim2.new(0.05, 0, 0.05, 0)
menuButton.Text = "Mở Menu"
menuButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
menuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
menuButton.Font = Enum.Font.GothamBold
menuButton.TextSize = 20
menuButton.Parent = screenGui
local menuButtonCorner = Instance.new("UICorner")
menuButtonCorner.CornerRadius = UDim.new(0, 8)
menuButtonCorner.Parent = menuButton

-- Frame chứa menu
local menuFrame = Instance.new("Frame")
menuFrame.Size = UDim2.new(0, 220, 0, 250)
menuFrame.Position = UDim2.new(0.5, -110, 0.5, -125)
menuFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
menuFrame.Visible = false
menuFrame.Parent = screenGui
local menuFrameCorner = Instance.new("UICorner")
menuFrameCorner.CornerRadius = UDim.new(0, 8)
menuFrameCorner.Parent = menuFrame

-- Nút bật/tắt Camera Pin (đẹp hơn)
local cameraToggleButton = Instance.new("TextButton")
cameraToggleButton.Size = UDim2.new(0, 180, 0, 50)
cameraToggleButton.Position = UDim2.new(0.5, -90, 0.2, 0)
cameraToggleButton.Text = "Bật Ghim Camera"
cameraToggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 150)
cameraToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
cameraToggleButton.Font = Enum.Font.GothamBold
cameraToggleButton.TextSize = 20
cameraToggleButton.Parent = menuFrame
local cameraToggleButtonCorner = Instance.new("UICorner")
cameraToggleButtonCorner.CornerRadius = UDim.new(0, 8)
cameraToggleButtonCorner.Parent = cameraToggleButton

menuButton.MouseButton1Click:Connect(function()
    menuFrame.Visible = not menuFrame.Visible
end)

-----------------------------------------------------------
-- HÀM CHỌN TARGET CÓ LINE-OF-SIGHT (không sau tường)
-----------------------------------------------------------
local function getNearestVisiblePlayer()
    local nearestPlayer = nil
    local shortestDistance = math.huge
    local camera = workspace.CurrentCamera
    local origin = camera.CFrame.Position
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
            local headPos = p.Character.Head.Position
            if player.Character then
                raycastParams.FilterDescendantsInstances = {p.Character, player.Character}
            else
                raycastParams.FilterDescendantsInstances = {p.Character}
            end
            local direction = headPos - origin
            local result = workspace:Raycast(origin, direction, raycastParams)
            if not result then
                local distance = direction.Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    nearestPlayer = p
                end
            end
        end
    end
    return nearestPlayer
end

-----------------------------------------------------------
-- CÀI ĐẶT CAMERA VỚI DỰ ĐOÁN DI CHUYỂN VÀ TWEEN
-----------------------------------------------------------
local isCameraPinned = false
local currentTarget = nil
local activeTween = nil

local function updateCameraAim()
    if not isCameraPinned then return end
    local camera = workspace.CurrentCamera
    if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Head") then
        local head = currentTarget.Character.Head
        local headPosition = head.Position
        local cameraPosition = camera.CFrame.Position

        -- Tính khoảng cách giữa camera và head của target
        local distance = (headPosition - cameraPosition).Magnitude
        -- Tính dynamicPredictionTime: nếu target càng xa thì thời gian dự đoán càng lớn (giới hạn từ 0.1 đến 0.5 giây)
        local dynamicPredictionTime = math.clamp(distance / 200, 0.1, 0.5)

        local predictedHeadPosition = headPosition
        local hrp = currentTarget.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            predictedHeadPosition = headPosition + hrp.Velocity * dynamicPredictionTime
        end

        -- Kiểm tra line-of-sight với vị trí dự đoán
        local rayParams = RaycastParams.new()
        rayParams.FilterType = Enum.RaycastFilterType.Blacklist
        if player.Character then
            rayParams.FilterDescendantsInstances = {currentTarget.Character, player.Character}
        else
            rayParams.FilterDescendantsInstances = {currentTarget.Character}
        end
        local direction = predictedHeadPosition - cameraPosition
        local rayResult = workspace:Raycast(cameraPosition, direction, rayParams)
        if rayResult then
            -- Nếu không có đường thẳng, chuyển target khác
            currentTarget = getNearestVisiblePlayer()
            return
        end

        local newCFrame = CFrame.new(cameraPosition, predictedHeadPosition)
        if activeTween then
            activeTween:Cancel()
        end
        local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
        activeTween = TweenService:Create(camera, tweenInfo, {CFrame = newCFrame})
        activeTween:Play()
    else
        currentTarget = getNearestVisiblePlayer()
    end
end

-- Theo dõi khi target chết để chuyển target ngay
local function monitorTargetDeath()
    if currentTarget and currentTarget.Character then
        local humanoid = currentTarget.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Died:Connect(function()
                currentTarget = getNearestVisiblePlayer()
            end)
        end
    end
end

-----------------------------------------------------------
-- TẠO RED DOT TRÊN ĐẦU NHÂN VẬT (THAY THẾ BILLBOARD TÊN & KHOẢNG CÁCH)
-----------------------------------------------------------
local function createRedDot(character)
    local head = character:WaitForChild("Head", 5)
    if head and not head:FindFirstChild("RedDotBillboard") then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "RedDotBillboard"
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 20, 0, 20)
        billboard.StudsOffset = Vector3.new(0, 2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = head

        local dot = Instance.new("Frame")
        dot.Size = UDim2.new(1, 0, 1, 0)
        dot.BackgroundColor3 = Color3.new(1, 0, 0)  -- màu đỏ
        dot.BorderSizePixel = 0
        dot.Parent = billboard
        local dotCorner = Instance.new("UICorner")
        dotCorner.CornerRadius = UDim.new(1, 0)
        dotCorner.Parent = dot
    end
end

-- Tạo red dot cho các người chơi khác
for _, p in pairs(game.Players:GetPlayers()) do
    if p ~= player then
        if p.Character then
            createRedDot(p.Character)
        end
        p.CharacterAdded:Connect(function(char)
            wait(0.1)
            createRedDot(char)
        end)
    end
end

-----------------------------------------------------------
-- SỰ KIỆN BẬT/TẮT GHIM CAMERA VỚI DỰ ĐOÁN DI CHUYỂN
-----------------------------------------------------------
cameraToggleButton.MouseButton1Click:Connect(function()
    isCameraPinned = not isCameraPinned
    if isCameraPinned then
        cameraToggleButton.Text = "Tắt Ghim Camera"
        currentTarget = getNearestVisiblePlayer()
        monitorTargetDeath()
    else
        cameraToggleButton.Text = "Bật Ghim Camera"
        currentTarget = nil
    end
end)

-----------------------------------------------------------
-- CẬP NHẬT CAMERA THEO HEARTBEAT
-----------------------------------------------------------
RunService.Heartbeat:Connect(function()
    if isCameraPinned then
        updateCameraAim()
    end
end)

-----------------------------------------------------------
-- Đảm bảo khi respawn, GUI vẫn còn và không bị lỗi
-----------------------------------------------------------
player.CharacterAdded:Connect(function(char)
    wait(0.5)
end)
