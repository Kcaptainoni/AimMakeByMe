local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Tạo GUI trong StarterGui để đảm bảo nó không bị mất khi chết
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.ResetOnSpawn = false  -- Đảm bảo GUI không bị xóa khi người chơi chết

local menuButton = Instance.new("TextButton")
menuButton.Size = UDim2.new(0, 100, 0, 50)
menuButton.Position = UDim2.new(0.1, 0, 0.1, 0)
menuButton.Text = "Mở Menu"
menuButton.Parent = screenGui

local menuFrame = Instance.new("Frame")
menuFrame.Size = UDim2.new(0, 200, 0, 200)
menuFrame.Position = UDim2.new(0.5, -100, 0.5, -100)
menuFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
menuFrame.Visible = false
menuFrame.Parent = screenGui

local cameraToggleButton = Instance.new("TextButton")
cameraToggleButton.Size = UDim2.new(0, 150, 0, 50)
cameraToggleButton.Position = UDim2.new(0.5, -75, 0.5, -25)
cameraToggleButton.Text = "Bật Ghim Camera"
cameraToggleButton.Parent = menuFrame

-- TweenService để mượt hóa chuyển động camera
local TweenService = game:GetService("TweenService")

-- Sự kiện mở menu
menuButton.MouseButton1Click:Connect(function()
    menuFrame.Visible = not menuFrame.Visible
end)

-- Hàm tìm player gần nhất (trừ người chơi hiện tại)
local function getNearestPlayer()
    local nearestPlayer = nil
    local shortestDistance = math.huge

    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
            local distance = (p.Character.Head.Position - player.Character.Head.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                nearestPlayer = p
            end
        end
    end

    return nearestPlayer
end

-- Biến để theo dõi camera
local isCameraPinned = false
local currentPlayer = nil
local activeTween = nil  -- Để theo dõi tween đang chạy

-- Ghim tâm camera vào đầu người chơi gần nhất với Tween để mượt hơn
local function updateCameraAim()
    if currentPlayer and currentPlayer.Character and currentPlayer.Character:FindFirstChild("Head") then
        local camera = game.Workspace.CurrentCamera
        local headPosition = currentPlayer.Character.Head.Position
        local cameraPosition = camera.CFrame.Position
        
        -- Tính toán CFrame mới từ camera tới đầu của player gần nhất
        local newCameraCFrame = CFrame.new(cameraPosition, headPosition)

        -- Nếu có tween đang chạy, hãy dừng lại
        if activeTween then
            activeTween:Cancel()
        end

        -- Tạo tween để di chuyển camera một cách mượt mà
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)  -- Tween thời gian dài hơn để mượt mà hơn
        activeTween = TweenService:Create(camera, tweenInfo, {CFrame = newCameraCFrame})
        activeTween:Play()
    end
end

-- Theo dõi khi player chết và đổi qua người gần nhất
local function onPlayerDeath()
    if currentPlayer and currentPlayer.Character then
        currentPlayer.Character.Humanoid.Died:Connect(function()
            local newPlayer = getNearestPlayer()
            if newPlayer then
                currentPlayer = newPlayer
                updateCameraAim()
            end
        end)
    end
end

-- Sự kiện bật/tắt ghim camera
cameraToggleButton.MouseButton1Click:Connect(function()
    isCameraPinned = not isCameraPinned
    if isCameraPinned then
        cameraToggleButton.Text = "Tắt Ghim Camera"
        currentPlayer = getNearestPlayer()
        updateCameraAim()
        onPlayerDeath()

        -- Sử dụng Heartbeat để cập nhật nhanh hơn
        game:GetService("RunService").Heartbeat:Connect(function()
            if isCameraPinned then
                updateCameraAim()
            end
        end)
    else
        cameraToggleButton.Text = "Bật Ghim Camera"
        game.Workspace.CurrentCamera.CameraSubject = player.Character.Humanoid  -- Trả về camera ban đầu
    end
end)
